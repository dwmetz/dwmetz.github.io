<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Beyond Hashes: Simplifying Malware Identification with Python and MpCmdRun | Baker Street Forensics</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Beyond Hashes: Simplifying Malware Identification with Python and MpCmdRun" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="None" />
<meta property="og:description" content="None" />
<link rel="canonical" href="http://localhost:4000/http:/bakerstreetforensics.com/2024/09/20/beyond-hashes-simplifying-malware-identification-with-python-and-mpcmdrun/" />
<meta property="og:url" content="http://localhost:4000/http:/bakerstreetforensics.com/2024/09/20/beyond-hashes-simplifying-malware-identification-with-python-and-mpcmdrun/" />
<meta property="og:site_name" content="Baker Street Forensics" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-20T15:38:49-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Beyond Hashes: Simplifying Malware Identification with Python and MpCmdRun" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-20T15:38:49-04:00","datePublished":"2024-09-20T15:38:49-04:00","description":"None","headline":"Beyond Hashes: Simplifying Malware Identification with Python and MpCmdRun","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/http:/bakerstreetforensics.com/2024/09/20/beyond-hashes-simplifying-malware-identification-with-python-and-mpcmdrun/"},"url":"http://localhost:4000/http:/bakerstreetforensics.com/2024/09/20/beyond-hashes-simplifying-malware-identification-with-python-and-mpcmdrun/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Baker Street Forensics" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Baker Street Forensics</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/http:/bakerstreetforensics.com/resources/">Links &amp; Resources</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Beyond Hashes: Simplifying Malware Identification with Python and MpCmdRun</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-09-20T15:38:49-04:00" itemprop="datePublished">Sep 20, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In an earlier post titled <em>“<a href="https://bakerstreetforensics.com/2024/02/01/growing-your-malware-corpus/">Growing Your Malware Corpus</a>”</em>, I outlined methods for building a comprehensive test corpus of malware for detection engineering. It covers using sources like VX-Underground for malware samples and details how to organize and unzip these files using Python scripts.</p>

<p>In today’s post we’re going to cover using Python to apply a standard naming methodology to all our malware samples.</p>

<p>Depending on where you curate your samples from, they could be named by their hash, or as they were identified during investigation, like invoice.exe. Depending on the size of your collection, I’d surmise it’s highly unlikely that they have a consistent naming format.</p>

<p>I don’t know about you, but a title that indicates the malware family and platform is a lot more useful to me than a hash value when perusing the corpus for a juicy malware sample. We can rename all our malware files using Python and the command line utility for Windows Defender.</p>

<p>Step 1: You’ll need to install Python on a Windows box that has Windows Defender.</p>

<h2 id="install-python">Install Python</h2>

<p>If you don’t have Python installed on your Windows machine, you can do so by downloading the installer from <a href="https://www.python.org/downloads/">python.org</a>, or alternatively, installing from the Windows store.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/install-python.png?w=1024" alt="" /><em>Windows Store installer for Python versions 3.7 to 3.12</em></p>

<h2 id="directory-exclusion">Directory Exclusion</h2>

<p>Within the Windows Defender Virus &amp; Threat protection settings, add an exclusion for the directory you’re going to be using with the malware. Make sure the exclusion is in place before connecting the drive with the malware so it doesn’t get nuked.</p>

<p>Note: Doing this assumes you’ve evaluated the potential risks associated with handling malware, even in controlled settings, and have taken safety precautions. <strong>This is not an exercise to be conducted on your corporate workstation.</strong></p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/directory-exclusion.png?w=1024" alt="" /><em>Screenshot of the D:\Malware Directory being excluded from Windows Defender.</em></p>

<h2 id="automatic-sample-submission">Automatic Sample submission</h2>

<p>It’s up to you if you want to disable the Automatic Sample submission. If you do, you’ll still may get prompted to send some.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/auto-submit-off.png?w=582" alt="" /><em>Automatic Sample Submission turned off in Windows Defender Configuration.</em> <img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/screenshot-2024-09-20-at-2.54.58e280afpm.png?w=537" alt="" /><em>Windows Defender requesting to send samples to Microsoft for further analysis.</em></p>

<h2 id="rename_malwarepy">Rename_Malware.py</h2>

<p>The star of this show is the python script that was shared on <a href="https://x.com/vxunderground/status/1835141032121389477"><del>twitter</del></a> from vx-underground.</p>

<p>The post walks through various options for utilizing Windows Defender command line, MpCPmdRun.exe. Using that information a Python script was developed to loop through the contents of a directory, analyze those files with Windows Defender, and then rename the files accordingly based on the malware identification.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/rename_malware.png?w=995" alt="" /><em>Python code for rename_malware.py in VS Code.</em></p>

<p>You can grab the code from the linked post, or a copy on my Github <a href="https://github.com/dwmetz/Toolbox/blob/main/rename_malware.py">here</a>.</p>

<p>Once you’ve got Python installed, directory exclusion configured, and a pocketful of kryptonite (malware), - you’re ready to go.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python rename_malware.py D:\Malware
</code></pre></div></div>

<p>Windows Defender command line will run through each file and rename them based on its detection.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/rename-in-action.png?w=1024" alt="" /><em>The script recursively renames the analyzed files.</em></p>

<p>I’m running this on a copy of my malware corpus of 30,000+ malware samples.</p>

<h2 id="counting-the-corpus">Counting the Corpus</h2>

<p>A bit of handy PowerShell math. Before and after the process I wanted to be sure of how many files were present to ensure that the antivirus didn’t remove any. I also wanted to exclude counting pdfs as many of the samples in my corpus also have accompanying write-ups.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/counting-malware.png?w=1024" alt="" /><em>Using PowerShell for selective file counting.</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ChildItem -Recurse -file | Where-Object { $_.Extension ne *.pdf" } | Measure-Object | Select Count
</code></pre></div></div>

<p>Back at the console the script is still running.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/still-going.png?w=1024" alt="" /><em>The script continues recursively renaming the analyzed files.</em> <img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/still-going.webp?w=480" alt="" /><em>Energizer Rabbit. “Still Going!”</em></p>

<p>Finally… not begrudgingly at all considering over 30,000 samples were analyzed, the script has reached the end of the samples.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/end-of-script.png?w=1024" alt="" /><em>Script has reached the end of the files.</em></p>

<p>If we do a directory listing on the contents of the malware directory, we see that the majority of the files have all been renamed based on their malware identification.</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/renamed.png?w=1024" alt="" /><em>File listing showing malware files named Trojan.Powershell… Trojan.Script… etc.</em></p>

<p>Hooray!</p>

<p><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/despicable-me-minions-1513410527.gif?w=498" alt="" /></p>

<p>That makes it much easier to search and query through the malware repository.</p>

<p>The last step… make a BACKUP. ;)</p>

  </div><a class="u-url" href="/http:/bakerstreetforensics.com/2024/09/20/beyond-hashes-simplifying-malware-identification-with-python-and-mpcmdrun/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Baker Street Forensics</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Baker Street Forensics</li><li><a class="u-email" href="mailto:dwmetz@gmail.com">dwmetz@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/dwmetz"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">dwmetz</span></a></li><li><a href="https://www.twitter.com/dwmetz"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">dwmetz</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Where Irregulars Are Part Of The Game.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
