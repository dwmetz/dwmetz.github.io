<!-- wp:paragraph -->
<p>Earlier today I was asked for a 'quick and easy' PowerShell to grab a packet capture on a Windows box. I didn't have anything on hand so I set off to the Google and returned with the necessary ingredients.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>The star of the show is <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj129382(v=ws.11)" target="_blank">netsh trace</a>, which is built into Windows. If we wanted to capture for 90 seconds, start the trace, wait 90 seconds, and stop it the syntax would be:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>netsh trace start capture=yes IPv4.Address=192.168.1.167 tracefile=c:\temp\capture.etl
Start-Sleep 90
netsh trace stop</code></pre>
<!-- /wp:code -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Note there are 3 lines (the first may wrap depending on windows size)</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Like Wireshark, you need to specify what interface you want to capture traffic from.  In the example above  192.168.1.167 is the active interface I want to capture. But what if I want to use this for automation and won't know in advance what the active IP address will be?</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>We can grab the local IPv4 address and save it as a variable.</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>#Get the local IPv4 address
$env:HostIP = (
    Get-NetIPConfiguration |
    Where-Object {
        $_.IPv4DefaultGateway -ne $null -and
        $_.NetAdapter.Status -ne "Disconnected"
    }
).IPv4Address.IPAddress</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>Now putting the two together:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>$env:HostIP = (
    Get-NetIPConfiguration |
    Where-Object {
        $_.IPv4DefaultGateway -ne $null -and
        $_.NetAdapter.Status -ne "Disconnected"
    }
).IPv4Address.IPAddress
netsh trace start capture=yes IPv4.Address=$env:HostIP tracefile=c:\temp\capture.etl
Start-Sleep 90
netsh trace stop</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>Perfect. Automated packet capture without having to install Wireshark on the host. The only item you should need to adjust will be the capture (sleep) timer.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>But wait, the request was for a pcap file.  Not a .etl.  Lucky for us there's an easy conversion utility <a rel="noreferrer noopener" href="https://github.com/microsoft/etl2pcapng/releases" target="_blank">etl2pcapng</a>. Execution is as simple as giving the exe the source and destination files.</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>./etl2pcapng.exe c:\temp\capture.etl c:\temp\capture.pcap</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>That's it.  We're now able to collect a packet capture on Windows hosts without adding any additional tools. We can then take those collections and convert them with ease to everyone's favorite packet analyzer.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>I've combined everything above into <a rel="noreferrer noopener" href="https://github.com/dwmetz/QuickPcap" target="_blank">QuickPcap.ps1</a> available on my GitHub site.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":634,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2022/01/quickpcap-1.png?w=1024" alt="" class="wp-image-634" /><figcaption class="wp-element-caption">QuickPcap.ps1</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>In this case the capture and conversion are running as one contiguous process, but it's easy to imagine them as separate automation elements being handled through scripting by different processes. After all, we all build our Lego's differently, don't we?</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":636,"width":220,"height":165,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large is-resized"><img src="https://bakerstreetforensics.com/wp-content/uploads/2022/01/sherlock_lego.jpg?w=960" alt="" class="wp-image-636" style="width:220px;height:165px" width="220" height="165" /><figcaption class="wp-element-caption">"The Game is On!"</figcaption></figure>
<!-- /wp:image -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Post-update</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Since this continues to be one of the most searched for topics, be sure to check out <strong>detonaRE</strong>, a malware detonation and capture utility that uses the same pcap functionality. </p>
<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https://youtu.be/lHi7zH9BicM?si=q6yzOBVIMgtZduZZ","type":"video","providerNameSlug":"youtube","responsive":true,"className":"wp-embed-aspect-16-9 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://youtu.be/lHi7zH9BicM?si=q6yzOBVIMgtZduZZ
</div></figure>
<!-- /wp:embed -->

<!-- wp:paragraph -->
<p><strong>detonaRE</strong>  initiates packet capture and process monitor, detonates the malware, ends pcap collection, completes evidence capture with Magnet RESPONSE. PCAP, Zip, and CSV outputs. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>blog: <a class="yt-core-attributed-string__link yt-core-attributed-string__link--display-type yt-core-attributed-string__link--call-to-action-color" href="https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqa3FldDFjXzBnVUJvN2ZoMzRadlNoTjJ4bjZsUXxBQ3Jtc0ttdmxjaXpmZmJXX09WMkF4c0d1OWFaaFRYTG5kbU00eXlSaWNNd1J6Wk91a0UzbFNDaDJsVTN1cGJOUjVfc0ZzLTZneTB0aW0ybDFqQm9PTHFOQzZHUVdybnFPYmFiTkVZQjRkQ2lwZzA0LUdxY1Zycw&amp;q=https%3A%2F%2Fbakerstreetforensics.com%2F2023%2F08%2F10%2Fcapturing-malware-evidence-with-detonare%2F&amp;v=lHi7zH9BicM" target="_blank" rel="noreferrer noopener">https://bakerstreetforensics.com/2023...</a> </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>GitHub: <a class="yt-core-attributed-string__link yt-core-attributed-string__link--display-type yt-core-attributed-string__link--call-to-action-color" href="https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqbGdTYVk4MlFta1Nma2xWejlhZjdMdEpHbEw0Z3xBQ3Jtc0tsaGlDU1RLLVFZT3lJOUF3eHRwVHprdTRsc1lIcWNGYkhaWklqQ3RUT21OUzN3eUdPLTE0c0pRaWxiZHU5OHVxN2QyUVpzQlhuVWpRV3Q1ZFlFWmYwcmNlNFpPYnhZOXZKNzJRc1ItbFFqajVqcWpuRQ&amp;q=https%3A%2F%2Fgithub.com%2Fdwmetz%2FdetonaRE&amp;v=lHi7zH9BicM" target="_blank" rel="noreferrer noopener">https://github.com/dwmetz/detonaRE</a></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->