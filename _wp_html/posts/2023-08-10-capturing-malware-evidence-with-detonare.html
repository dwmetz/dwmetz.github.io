<!-- wp:image {"id":1304,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2023/08/screenshot-2023-08-10-at-12.12.39e280afpm.png?w=1024" alt="" class="wp-image-1304" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Lately I've been experimenting with a lot of varieties of different malware strains.  Each time the malware executes, I have a process where I'll initiate a packet capture, give the malware some time to spin up, and  then execute an evidence capture while the malware is running.  Then I'll revert to a snapshot, make some modifications to the environment, and run the process again. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>To make things easier on myself (and to help with late afternoon brain fog) I decided to script out the process with PowerShell.</p>
<!-- /wp:paragraph -->

<!-- wp:quote -->
<blockquote class="wp-block-quote"><!-- wp:paragraph -->
<p><strong><em>detonaRE - from Latin,  to detonate</em></strong></p>
<!-- /wp:paragraph --></blockquote>
<!-- /wp:quote -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li> initiates packet capture</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li> launches malware sample</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li> terminates packet capture after specified interval</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li> initiates evidence collection with <a href="https://support.magnetforensics.com/s/article/Collect-evidence-for-incident-response-investigations-with-Magnet-RESPONSE">Magnet RESPONSE</a> (memory, process, and triage capture)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li> converts collected .etl file (network capture) to .pcap with <a href="https://github.com/microsoft/etl2pcapng">etl2pcapng</a>.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>## variable configuration:<br>$malwspath = "E:" ## malware source path<br>$malwdpath = "C:\Users\REM\Desktop\Malware\" ## malware destination path<br>$malware = "redline-76ca4a.exe" ## malware executable<br>$pcaptime = 180 ## duration in seconds for pcap capture<br>$toolsdir = "E:\Tools" ## MagnetRESPONSE.exe and etl2pcapng.exe</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>In my case I've got my malware file on the root of a USB device (E:) that will be attached to the VM. I want to copy the malware to the 'Malware' folder on the VM desktop. For this example the malware file is redline-76ca4a.exe. Any tools needed will be stored in E:\Tools.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>I'm using the netsh command to capture any network traffic in .etl format. Later on, we'll convert the .ett to .pcap.  This is the same process I utilized in the <a href="https://bakerstreetforensics.com/2022/01/07/quickpcap-capturing-a-pcap-with-powershell/">QuickPcap PowerShell script</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Once the packet capture is running, the malware file gets detonated. The packet capture will continue running for the set duration, the default being 180 seconds or 3 minutes. It's important not to terminate the packet capture too early.  As you can see in the demonstration video below, once this particular malware sample is detonated, it <em>sleeps</em> for a bit and doesn't show as active on the system until about 45 seconds into the capture.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Once the packet capture is completed, I'm running the command line version of Magnet RESPONSE. <strong><em>If you're a fan of <a href="https://github.com/dwmetz/CyberPipe">CyberPipe</a> this is definitely one you'll want to check out.</em></strong> Using Magnet RESPONSE I collect the memory (Comae DumpIt), pagefile, running processes (full process dumps) and triage system collection. <em>Note, these artifacts can be scaled down by adjusting the Magnet RESPONSE CLI parameters.</em></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Finally, when that's all done, the .etl file gets converted to .pcap via etl2pcapng.exe.  Then I transfer the collected files to my analysis machine and then the real fun begins.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>update: </strong>(a day later) version 1.1 now also initiates Process Monitor with a filter applied for the malware to be detonated. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><a href="https://github.com/dwmetz/detonaRE">Github link for detonaRE</a></p>
<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https://youtu.be/Waxo351UucM","type":"video","providerNameSlug":"youtube","responsive":true,"align":"left","className":"wp-embed-aspect-4-3 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed alignleft is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-4-3 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://youtu.be/Waxo351UucM
</div><figcaption class="wp-element-caption">detonaRE v1.0</figcaption></figure>
<!-- /wp:embed -->

<!-- wp:embed {"url":"https://youtu.be/XsnuJ_yJm3I","type":"video","providerNameSlug":"youtube","responsive":true,"align":"left","className":"wp-embed-aspect-4-3 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed alignleft is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-4-3 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://youtu.be/XsnuJ_yJm3I
</div><figcaption class="wp-element-caption">detonaRE.ps1 v1.1 now includes Process Monitor</figcaption></figure>
<!-- /wp:embed -->

<!-- wp:embed {"url":"https://youtu.be/lHi7zH9BicM","type":"video","providerNameSlug":"youtube","responsive":true,"align":"left","className":"wp-embed-aspect-16-9 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed alignleft is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://youtu.be/lHi7zH9BicM
</div><figcaption class="wp-element-caption">detonaRE version 1.2 demo</figcaption></figure>
<!-- /wp:embed -->