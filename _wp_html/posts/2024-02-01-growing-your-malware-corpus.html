<!-- wp:paragraph -->
<p>If you’re writing YARA rules or doing other kinds of detection engineering, you’ll want to have a test bed that you can run your rules against.&nbsp; This is known as a corpus. For your corpus you’ll want to have both <em>Goodware</em> (known good operating system files), as well as a library of malware files.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>One source to get a lot of malware samples is from <a href="https://vx-underground.org/">VX-Underground</a>.&nbsp; What I really appreciate about VX-Underground is that in addition to providing lots of malware samples, they also produce an <a href="https://vx-underground.org/APTs/Yearly%20Archives">annual archive</a> of samples and papers. You can download a whole year’s worth of samples and papers, from 2010 to 2023.</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Pandora’s Box</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Just to understand the structure here, I have a USB device called “Pandora.” On the root of the drive is a folder called “APT”, and within that is a “Samples” directory. Inside the samples directory is the .7z download for 2023 from VX-Underground. There’s also a python script… we’ll get to that soon enough.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2027,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/start-tree.png?w=990" alt="" class="wp-image-2027" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>The first thing we’ll need to do is unzip the download with <em>the usual password</em>.</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>7zz x 2023.7z</code></pre>
<!-- /wp:code -->

<!-- wp:image {"id":2028,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/initial-extraction.png?w=1014" alt="" class="wp-image-2028" /></figure>
<!-- /wp:image -->

<!-- wp:image {"id":2029,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/extract-dl.png?w=1015" alt="" class="wp-image-2029" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Once the initial extraction is complete you can delete the original 2023.7z archive.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Within the archive for each year, there is a directory for the sample, with sub-directories of ‘Samples’ and ‘Papers.’  Every one of the samples is also password protected zip file.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2030,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/pre-script.png?w=1024" alt="" class="wp-image-2030" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>This makes sense from a safety perspective, but it makes it impossible to scan against all the files at once.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2031,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/cook.png?w=640" alt="" class="wp-image-2031" /></figure>
<!-- /wp:image -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Python to the Rescue</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>We can utilize a Python script to recursively go through the contents of our malware folder and unzip all the password protected files, while keeping those files in their original directories.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>You may have noticed in the first screenshot that I have a script called <strong>ExtractSamples.py</strong> in my APT directory. </p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2027,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/start-tree.png?w=990" alt="" class="wp-image-2027" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>We will use this for the recursive password protected extractions.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2032,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/python.png?w=468" alt="" class="wp-image-2032" /></figure>
<!-- /wp:image -->

<!-- wp:code -->
<pre class="wp-block-code"><code>Python ExtractSamples.py</code></pre>
<!-- /wp:code -->

<!-- wp:image {"id":2033,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/extraction-complete.png?w=1024" alt="" class="wp-image-2033" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>A flurry of code goes by, and you congratulate yourself on you Python prowess. Now if we look again at our contents, we’ve got the extracted sample and the original zip file.&nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2034,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/tree-with-7z.png?w=1024" alt="" class="wp-image-2034" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Let’s get rid of all the zip files as we don’t need them cluttering up the corpus.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>We can start by running a find command to identify all the 7zip files.</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>find . -type f -name '*.7z' -print</code></pre>
<!-- /wp:code -->

<!-- wp:image {"id":2040,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/find-2.png?w=1024" alt="" class="wp-image-2040" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>After you’ve checked the output and verified the command above is <strong>only grabbing the 7z files you want to delete</strong>, we can update the command to delete the found files.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2042,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/delete-7zs.png?w=923" alt="" class="wp-image-2042" /></figure>
<!-- /wp:image -->

<!-- wp:code -->
<pre class="wp-block-code"><code>find . -type f -name '*.7z' -delete<br></code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>One more a directory listing to verify:</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2045,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/02/tree-end.png?w=1024" alt="" class="wp-image-2045" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Success. All the 7z files are removed and all the sample files are intact.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>GitHub Link: <a href="https://github.com/dwmetz/Toolbox/blob/main/ExtractSamples.py">ExtractSamples.py</a></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><em>Time to go write some new detections!</em></p>
<!-- /wp:paragraph -->