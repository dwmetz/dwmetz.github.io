<!-- wp:paragraph -->
<p>In an earlier post titled <em>“<a href="https://bakerstreetforensics.com/2024/02/01/growing-your-malware-corpus/">Growing Your Malware Corpus</a>”</em>, I outlined methods for building a comprehensive test corpus of malware for detection engineering. It covers using sources like VX-Underground for malware samples and details how to organize and unzip these files using Python scripts. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>In today’s post we’re going to cover using Python to apply a standard naming methodology to all our malware samples. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Depending on where you curate your samples from, they could be named by their hash, or as they were identified during investigation, like invoice.exe. Depending on the size of your collection, I'd surmise it's highly unlikely that they have a consistent naming format.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>I don’t know about you, but a title that indicates the malware family and platform is a lot more useful to me than a hash value when perusing the corpus for a juicy malware sample. We can rename all our malware files using Python and the command line utility for Windows Defender.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Step 1: You’ll need to install Python on a Windows box that has Windows Defender. </p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Install Python</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>If you don't have Python installed on your Windows machine, you can do so by downloading the installer from <a href="https://www.python.org/downloads/" target="_blank" rel="noreferrer noopener">python.org</a>, or alternatively, installing from the Windows store.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2249,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/install-python.png?w=1024" alt="" class="wp-image-2249" /><figcaption class="wp-element-caption"><em>Windows Store installer for Python versions 3.7 to 3.12</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Directory Exclusion</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Within the Windows Defender Virus &amp; Threat protection settings, add an exclusion for the directory you're going to be using with the malware. Make sure the exclusion is in place before connecting the drive with the malware so it doesn't get nuked.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Note: Doing this assumes you've evaluated the potential risks associated with handling malware, even in controlled settings, and have taken safety precautions. <strong>This is not an exercise to be conducted on your corporate workstation.</strong></p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2252,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/directory-exclusion.png?w=1024" alt="" class="wp-image-2252" /><figcaption class="wp-element-caption"><em>Screenshot of the D:\Malware Directory being excluded from Windows Defender.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Automatic Sample submission</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>It's up to you if you want to disable the Automatic Sample submission. If you do, you'll still may get prompted to send some.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2254,"width":"584px","height":"auto","sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large is-resized"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/auto-submit-off.png?w=582" alt="" class="wp-image-2254" style="width:584px;height:auto" /><figcaption class="wp-element-caption"><em>Automatic Sample Submission turned off in Windows Defender Configuration.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":2283,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/screenshot-2024-09-20-at-2.54.58e280afpm.png?w=537" alt="" class="wp-image-2283" /><figcaption class="wp-element-caption"><em>Windows Defender requesting to send samples to Microsoft for further analysis.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Rename_Malware.py</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>The star of this show is the python script that was shared on <a href="https://x.com/vxunderground/status/1835141032121389477" target="_blank" rel="noreferrer noopener"><s>twitter</s></a> from vx-underground. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>The post walks through various options for utilizing Windows Defender command line, MpCPmdRun.exe. Using that information a Python script was developed to loop through the contents of a directory, analyze those files with Windows Defender, and then rename the files accordingly based on the malware identification.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2256,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/rename_malware.png?w=995" alt="" class="wp-image-2256" /><figcaption class="wp-element-caption"><em>Python code for rename_malware.py in VS Code.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>You can grab the code from the linked post, or a copy on my Github <a href="https://github.com/dwmetz/Toolbox/blob/main/rename_malware.py">here</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Once you've got Python installed, directory exclusion configured, and a pocketful of kryptonite (malware), - you're ready to go.</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>python rename_malware.py D:\Malware</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>Windows Defender command line will run through each file and rename them based on its detection.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2262,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/rename-in-action.png?w=1024" alt="" class="wp-image-2262" /><figcaption class="wp-element-caption"><em>The script recursively renames the analyzed files.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>I'm running this on a copy of my malware corpus of 30,000+ malware samples. </p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading">Counting the Corpus</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>A bit of handy PowerShell math. Before and after the process I wanted to be sure of how many files were present to ensure that the antivirus didn't remove any. I also wanted to exclude counting pdfs as many of the samples in my corpus also have accompanying write-ups.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2264,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/counting-malware.png?w=1024" alt="" class="wp-image-2264" /><figcaption class="wp-element-caption"><em>Using PowerShell for selective file counting.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:code -->
<pre class="wp-block-code"><code>Get-ChildItem -Recurse -file | Where-Object { $_.Extension ne *.pdf" } | Measure-Object | Select Count</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>Back at the console the script is still running. </p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2266,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/still-going.png?w=1024" alt="" class="wp-image-2266" /><figcaption class="wp-element-caption"><em>The script continues recursively renaming the analyzed files.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":2268,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/still-going.webp?w=480" alt="" class="wp-image-2268" /><figcaption class="wp-element-caption"><em>Energizer Rabbit. "Still Going!"</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Finally... not begrudgingly at all considering over 30,000 samples were analyzed, the script has reached the end of the samples.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2276,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/end-of-script.png?w=1024" alt="" class="wp-image-2276" /><figcaption class="wp-element-caption"><em>Script has reached the end of the files.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>If we do a directory listing on the contents of the malware directory, we see that the majority of the files have all been renamed based on their malware identification.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2278,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/renamed.png?w=1024" alt="" class="wp-image-2278" /><figcaption class="wp-element-caption"><em>File listing showing malware files named Trojan.Powershell... Trojan.Script... etc.</em></figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Hooray!</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":2280,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2024/09/despicable-me-minions-1513410527.gif?w=498" alt="" class="wp-image-2280" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>That makes it much easier to search and query through the malware repository. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>The last step... make a BACKUP. ;)</p>
<!-- /wp:paragraph -->