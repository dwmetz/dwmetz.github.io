<!-- wp:paragraph -->
<p>If you're utilizing KAPE to collect triage collections, are you also collecting a RAM image with the operating system artifacts?<br>Included in the Modules section of KAPE there are three modules that can create a RAM image. The modules for DumpIt and Winpmem have been available for a while. <em>(I wrote the DumpIt module and Eric Capuano wrote the Winpmem module.)</em> Now you also have the option of using <strong>Magnet Ram Capture</strong> as an option. As with any of the KAPE modules if you're calling an executable, you need to ensure the .exe is present in the \modules\bin directory. KAPE does not distribute any 3rd party executables so you need to bring your own. You can download Magnet Ram Capture from the Magnet Free Tools site at <a href="https://www.magnetforensics.com/free-tools/">Free Tools - Magnet Forensics</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><em>Speaking of Magnet, I should say that I am, as of recent, an employee of Magnet Forensics. All views here, demented and otherwise, are my own and don't reflect the views or opinions of my employer. Now that all the lawyers are smiling, let's continue.</em></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>When utilizing KAPE you can either run the Memory collection module by itself...</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":548,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/kape-mrc-selection.png?w=1024" alt="" class="wp-image-548" /><figcaption>Magnet Ram Capture module in KAPE</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p><br>Or more likely, as part of a triage collection so you can get the necessary artifacts, as well as a RAM dump.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":550,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/kape-2.png?w=1024" alt="" class="wp-image-550" /><figcaption>KAPE Triage Collection along with Magnet Ram Capture</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p><br>While this does work to get both the artifacts and RAM capture, there are a couple issues with the process.</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>Best practices for forensics suggest imaging the RAM before making any other changes to the target</li><li>KAPE executes the Targets first and then proceeds to Modules (RAM collection)</li><li>After the KAPE memory collection completes the memory image will be included in the specified KAPE output (zip).</li><li>A copy of the memory image (raw) file stays on the computer, even if KAPE is transferring the data off to a remote location. <em>This appeared to be the case regardless of which memory capture utility is used.</em></li></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 id="csirt-collect-v3csirt-collect-is-a-powershell-script-that-i-wrote-to-automate-to-collection-of-a-ram-image-as-well-as-a-kape-triage-collection-i-wanted-to-observe-the-order-of-volatility-and-capture-the-ram-before-any-other-artifact-collection-occurs-version-3-by-default-leverages-magnet-ram-capture-to-collect-the-memory-you-can-utilize-winpmem-or-dumpit-with-a-minor-code-modification-speaking-of-magnet-i-should-say-that-i-am-as-of-recent-an-employee-of-magnet-forensics-that-said-all-views-here-twisted-or-not-are-my-own-and-don-t-reflect-the-views-or-opinions-of-my-employer-now-that-all-the-lawyers-are-smiling-let-s-continue-csirt-collectprerequisites-network-share-location-with-collections-folder-within-collections-2-subdirectories-memory-containing-magnet-ram-capture-mrc-exe-and-command-line-version-of-7zip-7za-exe-kape-default-directory-as-installed-the-script-will-map-a-drive-to-the-collections-share-update-to-reflect-the-network-share-for-your-environment-capture-a-memory-image-with-magnet-ram-capture-capture-a-triage-collection-with-kape-transfer-the-output-back-to-the-network-share">CSIRT-Collect v3</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>CSIRT-Collect is a PowerShell script that I wrote to automate to collection of a RAM image as well as a KAPE triage collection. I wanted to preserve the order of volatility and capture the RAM before any other artifact collection occurs. Version 3 by default leverages Magnet Ram Capture to collect the memory. You can utilize Winpmem or DumpIt with a minor code modification. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><br><strong>CSIRT-Collect</strong><br>Prerequisites:</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Network share location with "Collections" folder. Within 'Collections', 2 subdirectories:</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>Memory, containing Magnet Ram Capture (MRC.exe) and command line version of 7zip (7za.exe)</li><li>KAPE (default directory as installed)</li></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>The script will:</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>map a drive to the "Collections" share, (update the script to reflect the network share for your environment)</li><li>capture a memory image with Magnet Ram Capture,</li><li>capture a triage collection with KAPE, </li><li>transfer the output back to the network share,</li><li>create a text flag when the process has completed.</li></ul>
<!-- /wp:list -->

<!-- wp:image {"id":555,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/script-start.png?w=1024" alt="" class="wp-image-555" /><figcaption>Beginning of script. Temp directory on host is empty. Memory and KAPE folder available on Collections share.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":557,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/capture-ram.png?w=1024" alt="" class="wp-image-557" /><figcaption>Tools copied from server. RAM collection initiated.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":558,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/zip-ram.png?w=1024" alt="" class="wp-image-558" /><figcaption>Once the RAM Capture is completed, the script captures the Windows build info to a text file, and then zips up that with the raw image file to memdump (7zip).</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":563,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/remote-host-receiving-memory.png?w=1024" alt="" class="wp-image-563" /><figcaption>The memdump zip file containing the RAM and build info is renamed to reflect the hostname of the target. The zip file is transferred to the network into a folder named for the target.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":564,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/start-kape.png?w=1024" alt="" class="wp-image-564" /><figcaption>After the zipped memory image (seen here as 18GB compressed to 4.2GB) is transferred to the network, the KAPE triage collection is initiated. Note the C:\Temp\IR directory is gone and collection artifacts saved to C:\Temp\KAPE.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":566,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/kape-cleanup.png?w=1024" alt="" class="wp-image-566" /><figcaption>At the end of the KAPE collection, the artifacts are saved to a VHDX file and then compressed as a zip.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":568,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/script-complete.png?w=1024" alt="" class="wp-image-568" /><figcaption>Script completes with zipped VHDX and KAPE console logs, transferred to server location.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":570,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/memory-zip.png?w=970" alt="" class="wp-image-570" /><figcaption>The zipped memory collection with the windows build text file.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:image {"id":572,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/build-info.png?w=745" alt="" class="wp-image-572" /><figcaption>Windows build info in text file.  Use this value to assist in selecting Windows profile for processing with Volatility.  (Save the long time required when running kdbgscan).</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>At the very end of the script a "transfer complete" text file is written to the directory. This is an easy way to know that all the collection activity has completed. If being used for automation, the presence of this file can be used as a trigger to initiate further automation activities.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":574,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large"><img src="https://bakerstreetforensics.com/wp-content/uploads/2021/12/tx-complete.png?w=577" alt="" class="wp-image-574" /><figcaption>Contents of transfer-complete.txt.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>And that's it. One script to capture RAM, capture a triage image, and then transfer the collections back to the network.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>CSIRT-Collect can be initiated on the endpoint manually, invoked by EDR tools, as well as larger collection scenarios where the script can be pushed out via Group Policy.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center"><strong>Grab your copy of CSIRT-Collect here:</strong></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center"><a href="https://github.com/dwmetz/CSIRT-Collect" target="_blank" rel="noreferrer noopener">https://github.com/dwmetz/CSIRT-Collect</a></p>
<!-- /wp:paragraph -->