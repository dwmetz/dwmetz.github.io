---
layout: post
permalink: http://bakerstreetforensics.com/2023/08/10/capturing-malware-evidence-with-detonare/
title: Capturing malware evidence with detonaRE
description: None
date: 2023-08-10 18:07:24 -0000
last_modified_at: 2023-08-15 15:08:50 -0000
publish: true
pin: false
categories:
- DFIR
- PowerShell
- RAM
tags:
- Forensics
- Github
- Magnet
- Malware
- Memory
---
![](https://bakerstreetforensics.com/wp-content/uploads/2023/08/screenshot-2023-08-10-at-12.12.39e280afpm.png?w=1024)

Lately I've been experimenting with a lot of varieties of different malware strains. Each time the malware executes, I have a process where I'll initiate a packet capture, give the malware some time to spin up, and then execute an evidence capture while the malware is running. Then I'll revert to a snapshot, make some modifications to the environment, and run the process again. 

To make things easier on myself (and to help with late afternoon brain fog) I decided to script out the process with PowerShell.

> **_detonaRE - from Latin, to detonate_**

  * initiates packet capture
  * launches malware sample
  * terminates packet capture after specified interval
  * initiates evidence collection with [Magnet RESPONSE](https://support.magnetforensics.com/s/article/Collect-evidence-for-incident-response-investigations-with-Magnet-RESPONSE) (memory, process, and triage capture)
  * converts collected .etl file (network capture) to .pcap with [etl2pcapng](https://github.com/microsoft/etl2pcapng).



## variable configuration:  
$malwspath = "E:" ## malware source path  
$malwdpath = "C:\Users\REM\Desktop\Malware\" ## malware destination path  
$malware = "redline-76ca4a.exe" ## malware executable  
$pcaptime = 180 ## duration in seconds for pcap capture  
$toolsdir = "E:\Tools" ## MagnetRESPONSE.exe and etl2pcapng.exe

In my case I've got my malware file on the root of a USB device (E:) that will be attached to the VM. I want to copy the malware to the 'Malware' folder on the VM desktop. For this example the malware file is redline-76ca4a.exe. Any tools needed will be stored in E:\Tools.

I'm using the netsh command to capture any network traffic in .etl format. Later on, we'll convert the .ett to .pcap. This is the same process I utilized in the [QuickPcap PowerShell script](https://bakerstreetforensics.com/2022/01/07/quickpcap-capturing-a-pcap-with-powershell/).

Once the packet capture is running, the malware file gets detonated. The packet capture will continue running for the set duration, the default being 180 seconds or 3 minutes. It's important not to terminate the packet capture too early. As you can see in the demonstration video below, once this particular malware sample is detonated, it _sleeps_ for a bit and doesn't show as active on the system until about 45 seconds into the capture.

Once the packet capture is completed, I'm running the command line version of Magnet RESPONSE. **_If you're a fan of[CyberPipe](https://github.com/dwmetz/CyberPipe) this is definitely one you'll want to check out._** Using Magnet RESPONSE I collect the memory (Comae DumpIt), pagefile, running processes (full process dumps) and triage system collection. _Note, these artifacts can be scaled down by adjusting the Magnet RESPONSE CLI parameters._

Finally, when that's all done, the .etl file gets converted to .pcap via etl2pcapng.exe. Then I transfer the collected files to my analysis machine and then the real fun begins.

**update:**(a day later) version 1.1 now also initiates Process Monitor with a filter applied for the malware to be detonated. 

[Github link for detonaRE](https://github.com/dwmetz/detonaRE)

https://youtu.be/Waxo351UucM 

detonaRE v1.0

https://youtu.be/XsnuJ_yJm3I 

detonaRE.ps1 v1.1 now includes Process Monitor

https://youtu.be/lHi7zH9BicM 

detonaRE version 1.2 demo
