---
layout: post
permalink: http://bakerstreetforensics.com/2024/09/20/beyond-hashes-simplifying-malware-identification-with-python-and-mpcmdrun/
title: 'Beyond Hashes: Simplifying Malware Identification with Python and MpCmdRun'
description: None
date: 2024-09-20 19:38:49 -0000
last_modified_at: 2024-09-20 19:38:49 -0000
publish: true
pin: false
categories:
- DFIR
- Forensics
- PowerShell
tags:
- Defender
- Malware
- Python
- security
---
In an earlier post titled _“[Growing Your Malware Corpus](https://bakerstreetforensics.com/2024/02/01/growing-your-malware-corpus/)”_, I outlined methods for building a comprehensive test corpus of malware for detection engineering. It covers using sources like VX-Underground for malware samples and details how to organize and unzip these files using Python scripts. 

In today’s post we’re going to cover using Python to apply a standard naming methodology to all our malware samples. 

Depending on where you curate your samples from, they could be named by their hash, or as they were identified during investigation, like invoice.exe. Depending on the size of your collection, I'd surmise it's highly unlikely that they have a consistent naming format.

I don’t know about you, but a title that indicates the malware family and platform is a lot more useful to me than a hash value when perusing the corpus for a juicy malware sample. We can rename all our malware files using Python and the command line utility for Windows Defender.

Step 1: You’ll need to install Python on a Windows box that has Windows Defender. 

## Install Python

If you don't have Python installed on your Windows machine, you can do so by downloading the installer from [python.org](https://www.python.org/downloads/), or alternatively, installing from the Windows store.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/install-python.png?w=1024)_Windows Store installer for Python versions 3.7 to 3.12_

## Directory Exclusion

Within the Windows Defender Virus & Threat protection settings, add an exclusion for the directory you're going to be using with the malware. Make sure the exclusion is in place before connecting the drive with the malware so it doesn't get nuked.

Note: Doing this assumes you've evaluated the potential risks associated with handling malware, even in controlled settings, and have taken safety precautions. **This is not an exercise to be conducted on your corporate workstation.**

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/directory-exclusion.png?w=1024)_Screenshot of the D:\Malware Directory being excluded from Windows Defender._

## Automatic Sample submission

It's up to you if you want to disable the Automatic Sample submission. If you do, you'll still may get prompted to send some.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/auto-submit-off.png?w=582)_Automatic Sample Submission turned off in Windows Defender Configuration._ ![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/screenshot-2024-09-20-at-2.54.58e280afpm.png?w=537)_Windows Defender requesting to send samples to Microsoft for further analysis._

## Rename_Malware.py

The star of this show is the python script that was shared on [~~twitter~~](https://x.com/vxunderground/status/1835141032121389477) from vx-underground. 

The post walks through various options for utilizing Windows Defender command line, MpCPmdRun.exe. Using that information a Python script was developed to loop through the contents of a directory, analyze those files with Windows Defender, and then rename the files accordingly based on the malware identification.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/rename_malware.png?w=995)_Python code for rename_malware.py in VS Code._

You can grab the code from the linked post, or a copy on my Github [here](https://github.com/dwmetz/Toolbox/blob/main/rename_malware.py).

Once you've got Python installed, directory exclusion configured, and a pocketful of kryptonite (malware), - you're ready to go.
    
    
    python rename_malware.py D:\Malware

Windows Defender command line will run through each file and rename them based on its detection.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/rename-in-action.png?w=1024)_The script recursively renames the analyzed files._

I'm running this on a copy of my malware corpus of 30,000+ malware samples. 

## Counting the Corpus

A bit of handy PowerShell math. Before and after the process I wanted to be sure of how many files were present to ensure that the antivirus didn't remove any. I also wanted to exclude counting pdfs as many of the samples in my corpus also have accompanying write-ups.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/counting-malware.png?w=1024)_Using PowerShell for selective file counting._
    
    
    Get-ChildItem -Recurse -file | Where-Object { $_.Extension ne *.pdf" } | Measure-Object | Select Count

Back at the console the script is still running. 

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/still-going.png?w=1024)_The script continues recursively renaming the analyzed files._ ![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/still-going.webp?w=480)_Energizer Rabbit. "Still Going!"_

Finally... not begrudgingly at all considering over 30,000 samples were analyzed, the script has reached the end of the samples.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/end-of-script.png?w=1024)_Script has reached the end of the files._

If we do a directory listing on the contents of the malware directory, we see that the majority of the files have all been renamed based on their malware identification.

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/renamed.png?w=1024)_File listing showing malware files named Trojan.Powershell... Trojan.Script... etc._

Hooray!

![](https://bakerstreetforensics.com/wp-content/uploads/2024/09/despicable-me-minions-1513410527.gif?w=498)

That makes it much easier to search and query through the malware repository. 

The last step... make a BACKUP. ;)
