---
layout: post
permalink: http://bakerstreetforensics.com/2023/11/01/huntress-ctf-week-1-malware-hot-off-the-press-humantwo-php-stager-zerion/
title: 'Huntress CTF: Week 1 - Malware: Hot Off The Press, HumanTwo, PHP Stager &amp;
  Zerion'
description: None
date: 2023-11-01 17:00:00 -0000
last_modified_at: 2023-10-22 11:14:46 -0000
publish: true
pin: false
categories:
- CTF
- DFIR
- Malware
- PowerShell
tags:
- base64
- CyberChef
- decode.fr
- diff
- meld
- Perl
- Python
- the_silver_searcher
- uuencode
---
## Hot Off The Press

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-12.46.34e280afpm.png?w=1024)

To start with let's see what kind of file this is.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-12.48.33e280afpm.png?w=995)

> "**UHARC**  is a compression/archiving system for PC platforms, which appears to be neglected since around 2005. It achieves better compression than most other archivers, at the expense of being much slower." 
> 
> http://fileformats.archiveteam.org/wiki/UHARC

I scoured the internet looking for a copy of UHARC to download. I'm not going to link any here as many if not all may contain malware. Since this is a Windows only tool, (or Wine under Linux), we'll open this one in a sandboxed Windows system.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-12.55.17e280afpm.png?w=716)

When the file extracts we are presented with hot_off_the_press.ps1.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.00.48e280afam.png?w=1024)

OMG that's a lot of obfuscation! Let's see if we can clean this up and make it more readable. First let's remove all the ''+''

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.02.44e280afam.png?w=1024)

That's a little bit better. There's another obfuscation method going on where specific numbers are used to represent different letters. Originally, I tried to determine the substitution by completing terms I knew. Early ahead I saw (''Sc{2}i'pt{1}loc{0}Logging'') which to me reads like ScriptBlockLogging. So all 2's are i's, 1's are B's, and 0's are k. I do a find/replace through the script with replacements on {0},{1}, and {2}. Now it looks like a block of Base64 in the middle block. I copy it over to CyberChef and ... NADA. Something's not right.

If you look closer at the code, you'll see that each one of the strings that had a {#} substitution in it ends with "-f" followed by other letters in quotations. The first character after -f is substituted for {0}, the next for {1}, etc. So I run the same substitution pattern on the script using the correct letters for this string this time. 

Replace the {0} with L.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.05.52e280afam.png?w=1024)

Replace the {1} with E.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.06.25e280afam.png?w=1024)

Now we've got a nice clean block of Base64.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.08.03e280afam.png?w=1024)

Bring that over to CyberChef for decoding and:

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.09.22e280afam.png?w=1024)

We've got a script within the script.

If you scroll down in the output, you'll see that there's something else encoded as well.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.10.07e280afam.png?w=939)

We'll run that through CyberChef.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.10.55e280afam.png?w=1024)

Interesting we have an encoded_flag. Let's add URL decode to the recipe.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.11.25e280afam.png?w=1024)

* * *

## HumanTwo

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-11.21.25e280afam.png?w=1024)

There were 1,000 files in the zip container. Easy comparison options like file size, modification date etc. don't help as they are the same for all the files. It's something in the content that has to be different. How the 'f' am I going to find the outlier in 1,000 files?! [Meld](https://meldmerge.org) and diff are two options coming up in the Discord. I install Meld, which is really a gui for diff, and start getting a feel for it. You can compare files or directories. If doing files you could do a 3 way comparison between 3 files. But not 1000. As I was looking through the files with Meld it struck me that all of the file contents we also the same with the exception of one line.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-1.34.18e280afpm.png?w=1024)

Let's run through all the files with the_silver_searcher and isolate on **String.Equals**

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-04-at-2.56.09e280afpm.png?w=639)

Scrolling down through the output we see that one is a definite outlier, or as we like to say around here, an **_Irregular_**.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-04-at-2.55.04e280afpm.png?w=1024)

Once more to CyberChef, this time from Hex.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-10.47.02e280afam.png?w=1024)

* * *

## PHP Stager

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-06-at-9.20.04e280afam.png?w=793)

Heavily obfuscated PHP. This is going to be fun.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-1.49.33e280afpm.png?w=1024)

Let's see if ChatGPT can give some insight into what's going on here.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-1.57.50e280afpm.png?w=856)

After several hours of back and forth from PHP to Python to PowerShell, online IDE's, more ChatGPT, googling, and back again I was able to roughly reproduce the PHP in a Python and get it to execute.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/maxresdefault-209118682.jpeg?w=1024) ![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-3.09.13e280afpm.png?w=1024)

Looks like we're not done yet. In the middle of the output we can see another block of Base64. What happens if we toss that into CyberChef.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-3.11.44e280afpm.png?w=1024)

Great! Now we have a Perl script. How far down does this challenge go? It's like those Matryoshka dolls from Russia. One inside another inside another. But wait... there's something interesting in the Perl script.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-3.15.37e280afpm.png?w=706)

There's a reference to UU encoding and a string. We'll copy the string and bring it over to another of my favorite decoding sites, [dcode.fr](https://www.dcode.fr/).

Sure enough it handles the decoding and we have our flag.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-07-at-8.41.29e280afam.png?w=1024)

* * *

# Zerion

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-05-at-10.57.45e280afam.png?w=1024)

Yay (said no one), another crazy PHP file.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-3.24.43e280afpm.png?w=1024)

Looks to be using Base64 encoding, Rot13, and some other options to obfuscate the code. Back to school (ChatGPT) to see what's going on.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-09-at-3.29.17e280afpm.png?w=751)

Let's copy the large encoded text block to CyberChef. We'll apply Rot13, then Reverse the text by Character, and finally - decrypt using Base64.

![](https://bakerstreetforensics.com/wp-content/uploads/2023/10/screenshot-2023-10-03-at-9.10.02e280afam-1.png?w=1024)

And that's our flag!

* * *

Use the tag [**#HuntressCTF**](https://bakerstreetforensics.com/tag/HuntressCTF/) on BakerStreetForensics.com to see all related posts and solutions for the 2023 Huntress CTF.
